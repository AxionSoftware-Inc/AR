<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Pro AR Navigation</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
        #ui-panel {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 85%; background: rgba(0,0,0,0.8); color: white;
            padding: 15px; border-radius: 15px; font-family: 'Segoe UI', sans-serif;
            z-index: 100; text-align: center; border: 2px solid #00ff00;
        }
        .dist-text { font-size: 24px; font-weight: bold; color: #00ff00; }
        .info-text { font-size: 14px; opacity: 0.8; }
    </style>
</head>
<body>

    <div id="ui-panel">
        <div id="room-name">Yuklanmoqda...</div>
        <div class="dist-text"><span id="meter">0</span> m</div>
        <div id="status" class="info-text">Siz 6DoF rejimidasiz (Yuring)</div>
    </div>

    <a-scene webxr="requiredFeatures: local-floor">
        <a-assets>
            <a-mixin id="arrow-style" 
                geometry="primitive: cone; radiusBottom: 0.15; height: 0.4" 
                material="color: #00ff00; opacity: 0.8; emissive: #00ff00"
                animation="property: position; dir: alternate; dur: 1000; easing: easeInOutSine; loop: true; to: 0 0.2 0">
            </a-mixin>
        </a-assets>

        <a-camera id="user-cam" position="0 1.6 0"></a-camera>

        <a-entity id="world"></a-entity>
    </a-scene>

    <script>
        // 1. Xonalar ma'lumotlar bazasi (Koridor bo'ylab koordinatalar)
        const rooms = {
            "101": { x: 5, z: -2, label: "101-Xona (O'ngda)" },
            "102": { x: -5, z: -5, label: "102-Xona (Chapda)" },
            "103": { x: 0, z: -15, label: "103-Xona (To'g'rida)" },
            "105": { x: 3, z: -20, label: "Adminstratsiya" }
        };

        // URL'dan xonani aniqlash: ?room=103
        const urlParams = new URLSearchParams(window.location.search);
        const targetRoom = urlParams.get('room') || "103";
        const targetData = rooms[targetRoom];

        const world = document.querySelector('#world');
        const meterEl = document.querySelector('#meter');
        const roomNameEl = document.querySelector('#room-name');
        const statusEl = document.querySelector('#status');

        if (targetData) {
            roomNameEl.innerText = targetData.label;
            setupNavigation(targetData);
        }

        function setupNavigation(data) {
            // 2. Yo'lga strelkalarni tizish (Har 1.5 metrda)
            const steps = Math.abs(data.z) / 1.5;
            for (let i = 1; i <= steps; i++) {
                let s = document.createElement('a-entity');
                s.setAttribute('mixin', 'arrow-style');
                // Strelkalarni Z o'qi bo'ylab (to'g'riga) tizish
                s.setAttribute('position', `0 0.1 ${-i * 1.5}`);
                s.setAttribute('rotation', '-90 0 0');
                world.appendChild(s);
            }

            // 3. Xonaning o'ziga belgi qo'yish
            let goal = document.createElement('a-sphere');
            goal.setAttribute('position', `${data.x} 0.5 ${data.z}`);
            goal.setAttribute('radius', '0.5');
            goal.setAttribute('color', '#ff0000');
            world.appendChild(goal);
        }

        // 4. 6DoF va 3DoF aniqlash va Masofa o'lchash
        AFRAME.registerComponent('nav-engine', {
            tick: function () {
                const camPos = document.querySelector('#user-cam').object3D.position;
                
                // 3DoF vs 6DoF tekshiruvi (Oddiy usul: agar pozitsiya o'zgarmasa)
                if (camPos.x === 0 && camPos.z === 0) {
                    statusEl.innerText = "Eski telefon: Faqat yo'nalishni ko'rsatadi (3DoF)";
                    statusEl.style.color = "yellow";
                }

                if (targetData) {
                    const dist = Math.sqrt(
                        Math.pow(targetData.x - camPos.x, 2) + 
                        Math.pow(targetData.z - camPos.z, 2)
                    );
                    
                    meterEl.innerText = dist.toFixed(1);

                    if (dist < 2) {
                        statusEl.innerText = "Manzilga yetdingiz!";
                        statusEl.style.color = "#00ff00";
                        roomNameEl.style.color = "#00ff00";
                    }
                }
            }
        });

        document.querySelector('a-scene').setAttribute('nav-engine', '');
    </script>
</body>
</html>